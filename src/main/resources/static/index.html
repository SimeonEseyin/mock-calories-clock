<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mock Live Clock</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #metricValue {
            font-size: 48px;
            margin-top: 20px;
        }
        select {
            font-size: 20px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
<h1>Mock Live Clock</h1>
<select id="metricSelect">
    <option value="">Loading metrics...</option>
</select>
<div id="metricValue">loading...</div>

<script>
    let currentData = null;
    let timerId = null;

    // Fetch available metrics and populate dropdown
    async function loadMetrics() {
        try {
            const res = await fetch('/metrics');
            const keys = await res.json();

            const select = document.getElementById('metricSelect');
            select.innerHTML = ''; // clear placeholder

            keys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.text = key;
                select.appendChild(option);
            });

            // load first metric by default
            if (keys.length > 0) {
                select.value = keys[0];
                loadMetric(keys[0]);
            }

            // add change listener
            select.addEventListener('change', (e) => {
                loadMetric(e.target.value);
            });

        } catch (err) {
            console.error(err);
            document.getElementById('metricValue').innerText = "Error fetching metric list";
        }
    }

    // Load a metric by key
    async function loadMetric(metricKey) {
        try {
            const res = await fetch(`/metric/${metricKey}`);
            const data = await res.json();
            currentData = data;

            if (timerId) clearInterval(timerId);

            const valueEl = document.getElementById('metricValue');

            function render() {
                const now = new Date();
                const updatedAt = new Date(currentData.updatedAt);
                const deltaSec = (now - updatedAt) / 1000;
                const current = currentData.seedValue + (currentData.growthPerSecond * deltaSec);
                valueEl.innerText = Math.floor(current).toLocaleString();
            }

            render();
            timerId = setInterval(render, 100);

        } catch (err) {
            console.error(err);
            document.getElementById('metricValue').innerText = "Error fetching metric";
        }
    }

    loadMetrics();
</script>
</body>
</html>
